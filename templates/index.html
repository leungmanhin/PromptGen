{% extends "base.html" %}

{% block title %}NL2PLN Promptgen - Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="mb-4">PLN Program Dashboard</h1>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card mb-4">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Programs</h5>
                <div>
                    <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#createProgramModal" type="button">
                        <i class="fas fa-plus"></i> New Program
                    </button>
                </div>
            </div>
            <div class="card-body">
                <h6>Current Program: 
                    {% if app_state.current_program_id %}
                        <span class="badge bg-success">
                            {{ app_state.programs[app_state.current_program_id].get('task_name', 'Unknown') }} 
                            ({{ app_state.programs[app_state.current_program_id].get('model', 'Unknown Model') }})
                        </span>
                        <a href="{{ url_for('main.edit_program_instructions') }}" class="btn btn-sm btn-outline-secondary ms-2">Edit Instructions</a>
                    {% else %}
                        <span class="badge bg-warning">None Selected</span>
                        <div class="alert alert-warning mt-2">
                            <strong>Warning:</strong> You must select or create a program to generate samples and perform optimization.
                        </div>
                    {% endif %}
                </h6>
                
                {% if app_state.programs %}
                    <div class="list-group mt-3" id="program-list">
                        {% for program_id, metadata in app_state.programs.items() %}
                            <div class="list-group-item {% if program_id == app_state.current_program_id %}active{% endif %}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <a href="{{ url_for('main.select_program', program_id=program_id) }}" 
                                       class="text-decoration-none {% if program_id == app_state.current_program_id %}text-white{% endif %} flex-grow-1">
                                        <div>
                                            <strong>{{ metadata.get('task_name', 'Unknown') }}</strong> - 
                                            {{ metadata.get('model', 'Unknown Model') }}
                                            <small class="d-block {% if program_id == app_state.current_program_id %}text-light{% else %}text-muted{% endif %}">
                                                Created: {{ metadata.get('created_at')|timestamp_to_date }}
                                            </small>
                                            {% if metadata.get('base_program_id') %}
                                            <small class="d-block {% if program_id == app_state.current_program_id %}text-light{% else %}text-muted{% endif %}">
                                                Based on: {{ metadata.get('base_program_id') }}
                                            </small>
                                            {% endif %}
                                        </div>
                                    </a>
                                    <div class="d-flex">
                                        {% if program_id == app_state.current_program_id %}
                                        <span class="badge bg-primary rounded-pill me-2">Current</span>
                                        {% endif %}
                                        <form method="POST" action="{{ url_for('main.delete_program', program_id=program_id) }}" 
                                              onsubmit="return confirm('Are you sure you want to delete this program?')">
                                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-info mt-3">
                        <strong>No programs found!</strong> Click the "New Program" button above to create your first program.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Samples Overview</h5>
            </div>
            <div class="card-body">
                <p>Total samples: <strong>{{ samples|length }}</strong></p>
                <a href="/samples" class="btn btn-outline-primary">View All Samples</a>
                <a href="/add_sample" class="btn btn-outline-success">Add New Sample</a>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Optimization</h5>
            </div>
            <div class="card-body">
                <p>Optimize the model using the current samples.</p>
                <div class="mb-3">
                    <label for="optimization-model" class="form-label">Model:</label>
                    <select class="form-select" id="optimization-model">
                        {% for model in models %}
                        <option value="{{ model }}" {% if model == current_model %}selected{% endif %}>{{ model }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button id="optimize-btn" class="btn btn-success" {% if optimization_running %}disabled{% endif %}>
                    {% if optimization_running %}Optimization Running...{% else %}Start Optimization{% endif %}
                </button>
                <div id="optimization-status" class="mt-3" style="{% if not optimization_running %}display: none;{% endif %}">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                    </div>
                    <p class="text-center mt-1">Optimization in progress...</p>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Evaluation</h5>
            </div>
            <div class="card-body">
                <p>Evaluate the current model against the samples.</p>
                <div class="mb-3">
                    <label for="evaluation-model" class="form-label">Evaluation Model:</label>
                    <select class="form-select" id="evaluation-model">
                        {% for model in models %}
                        <option value="{{ model }}" {% if model == current_model %}selected{% endif %}>{{ model }}</option>
                        {% endfor %}
                    </select>
                    <small class="form-text text-muted">Model used to run the optimized task</small>
                </div>
                <div class="mb-3">
                    <label for="similarity-model" class="form-label">Similarity Scoring Model:</label>
                    <select class="form-select" id="similarity-model">
                        <option value="">Same as Evaluation Model</option>
                        {% for model in models %}
                        <option value="{{ model }}">{{ model }}</option>
                        {% endfor %}
                    </select>
                    <small class="form-text text-muted">Model used to calculate similarity scores (defaults to evaluation model if not selected)</small>
                </div>
                <button id="evaluate-btn" class="btn btn-info">Run Evaluation</button>
                <div id="evaluation-status" class="mt-3" style="display: none;">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" role="progressbar" style="width: 100%"></div>
                    </div>
                    <p class="text-center mt-1">Evaluation in progress...</p>
                </div>
                <div id="evaluation-results" class="mt-3" style="{% if not evaluation_results %}display: none;{% endif %}">
                    <h6>Evaluation Results:</h6>
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm">
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if evaluation_results and evaluation_results.metrics %}
                                    {% for metric, value in evaluation_results.metrics.items() %}
                                    <tr>
                                        <td>{{ metric }}</td>
                                        <td>{{ value }}</td>
                                    </tr>
                                    {% endfor %}
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                    
                    {% if evaluation_results %}
                    <div class="text-center mt-3">
                        <a href="/evaluation_results" class="btn btn-primary">View Detailed Results</a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Recent Samples</h5>
            </div>
            <div class="card-body">
                <div class="list-group">
                    {% if samples %}
                        {% for sample in samples[:3] %}
                            <a href="/sample/{{ loop.index0 }}" class="list-group-item list-group-item-action">
                                <div class="d-flex w-100 justify-content-between">
                                            <h5 class="mb-1">{{ sample.english|default('No input')|truncate(50) }}</h5>
                                </div>
                                <p class="mb-1">Types: {{ sample.pln_types|default('N/A')|truncate(50) }}</p>
                            </a>
                        {% endfor %}
                        {% if samples|length > 3 %}
                            <a href="/samples" class="list-group-item list-group-item-action text-center">View all samples</a>
                        {% endif %}
                    {% else %}
                        <div class="list-group-item">No samples available.</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Program Modal -->
<div class="modal fade" id="createProgramModal" tabindex="-1" aria-labelledby="createProgramModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createProgramModalLabel">Create New Program</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('main.create_program') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="create-program-model" class="form-label">Program Model:</label>
                        <select class="form-select" id="create-program-model" name="model">
                            {% for model in models %}
                            <option value="{{ model }}" {% if model == current_model %}selected{% endif %}>{{ model }}</option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">Model to use for the new program</small>
                    </div>
                    <div class="mb-3">
                        <label for="base-program-id" class="form-label">Base Program (Optional):</label>
                        <select class="form-select" id="base-program-id" name="base_program_id">
                            <option value="">None (Create Empty Program)</option>
                            {% for program_id, metadata in app_state.programs.items() %}
                            <option value="{{ program_id }}" {% if program_id == app_state.current_program_id %}selected{% endif %}>
                                {{ metadata.get('task_name', 'Unknown') }} ({{ program_id }})
                            </option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">Base program to use as a starting point</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Program</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Optimization handling
        $('#optimize-btn').click(function() {
            $(this).prop('disabled', true);
            $(this).text('Optimization Running...');
            $('#optimization-status').show();
            
            // Get the selected model
            var model = $('#optimization-model').val();
            
            $.ajax({
                url: '/optimize',
                type: 'POST',
                data: {
                    model: model
                },
                success: function(data) {
                    if (data.status === 'started') {
                        checkOptimizationStatus();
                    } else if (data.status === 'error') {
                        alert('Error: ' + data.message);
                        
                        // If the error is about program selection, ask if they want to create a program
                        if (data.message && data.message.includes("No program selected")) {
                            if (confirm("No program selected. Would you like to create one now?")) {
                                $('#createProgramModal').modal('show');
                            }
                        }
                        
                        $('#optimize-btn').prop('disabled', false);
                        $('#optimize-btn').text('Start Optimization');
                        $('#optimization-status').hide();
                    } else {
                        alert('Optimization already running');
                    }
                },
                error: function() {
                    alert('Error starting optimization');
                    $('#optimize-btn').prop('disabled', false);
                    $('#optimize-btn').text('Start Optimization');
                    $('#optimization-status').hide();
                }
            });
        });
        
        function checkOptimizationStatus() {
            $.ajax({
                url: '/optimization_status',
                type: 'GET',
                success: function(data) {
                    if (data.running) {
                        setTimeout(checkOptimizationStatus, 2000);
                    } else {
                        $('#optimize-btn').prop('disabled', false);
                        $('#optimize-btn').text('Start Optimization');
                        $('#optimization-status').hide();
                        location.reload();
                    }
                },
                error: function() {
                    $('#optimize-btn').prop('disabled', false);
                    $('#optimize-btn').text('Start Optimization');
                    $('#optimization-status').hide();
                }
            });
        }
        
        // Evaluation handling
        $('#evaluate-btn').click(function() {
            $(this).prop('disabled', true);
            $('#evaluation-status').show();
            $('#evaluation-results').hide();
            
            // Get the selected model
            var model = $('#evaluation-model').val();
            
            $.ajax({
                url: '/evaluate',
                type: 'POST',
                data: {
                    model: model,
                    similarity_model: $('#similarity-model').val()
                },
                success: function(data) {
                    $('#evaluate-btn').prop('disabled', false);
                    $('#evaluation-status').hide();
                    
                    if (data.status === 'success') {
                        // Reload the page to show the summary metrics
                        location.reload();
                    } else {
                        alert('Error running evaluation: ' + (data.error || data.message || 'Unknown error'));
                    }
                },
                error: function() {
                    alert('Error running evaluation');
                    $('#evaluate-btn').prop('disabled', false);
                    $('#evaluation-status').hide();
                }
            });
        });
        
        {% if optimization_running %}
        // Check status if optimization is already running
        checkOptimizationStatus();
        {% endif %}
    });
</script>
{% endblock %}

